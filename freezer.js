(function(m,f){"function"===typeof define&&define.amd?define([],f):"object"===typeof exports?module.exports=f():m.Freezer=f()})(this,function(){var m=(new Function("return this"))(),f={extend:function(a,c){for(var b in c)a[b]=c[b];return a},createNonEnumerable:function(a,c){var b={},d;for(d in a)b[d]={value:a[d]};return Object.create(c||{},b)},error:function(a){a=Error(a);if(console)return console.error(a);throw a;},each:function(a,c){var b,d,g;if(a&&a.constructor==Array)for(b=0,d=a.length;b<d;b++)c(a[b],
b);else for(g=Object.keys(a),b=0,d=g.length;b<d;b++)c(a[g[b]],g[b])},addNE:function(a,c){for(var b in c)Object.defineProperty(a,b,{enumerable:!1,configurable:!0,writable:!0,value:c[b]})},createNE:function(a){var c={},b;for(b in a)c[b]={writable:!0,configurable:!0,enumerable:!1,value:a[b]};return c},nextTick:function(){function a(){for(;g=b.shift();)g();d=!1}function c(a){b.push(a);d||(d=!0,f())}var b=[],d=!1,g,e=!!m.postMessage&&"undefined"!=typeof Window&&m instanceof Window,f=function(){return e?
function(){m.postMessage("nexttick","*")}:function(){setTimeout(function(){l()},0)}}(),l=function(){return e?function(b){b.source===m&&"nexttick"===b.data&&(b.stopPropagation(),a())}:a}();e&&m.addEventListener("message",l,!0);c.removeListener=function(){m.removeEventListener("message",l,!0)};return c}(),findPivot:function(a){if(a&&a.__){if(a.__.pivot)return a;var c=0;a=a.__.parents;for(var b=0,d;!c&&b<a.length;)d=a[b],d.__.pivot&&(c=d),b++;if(c)return c;for(b=0;!c&&b<a.length;)c=this.findPivot(a[b]),
b++;return c}},isLeaf:function(a,c){var b;return!a||!(b=a.constructor)||(c?b===String||b===Number||b===Boolean:b!=Object&&b!=Array)}},n={init:function(a){var c={set:function(a,b){var c=a,d=this.__.trans;"object"!=typeof a&&(c={},c[a]=b);if(!d){for(var l in c)d=d||this[l]!==c[l];if(!d)return f.findPivot(this)||this}return this.__.store.notify("merge",this,c)},reset:function(a){return this.__.store.notify("replace",this,a)},getListener:function(){return a.createListener(this)},toJS:function(){var a;
a=this.constructor==Array?Array(this.length):{};f.each(this,function(b,c){a[c]=b&&b.__?b.toJS():b});return a},transact:function(){return this.__.store.notify("transact",this)},run:function(){return this.__.store.notify("run",this)},now:function(){return this.__.store.notify("now",this)},pivot:function(){return this.__.store.notify("pivot",this)}},b=f.extend({push:function(a){return this.append([a])},append:function(a){return a&&a.length?this.__.store.notify("splice",this,[this.length,0].concat(a)):
this},pop:function(){return this.length?this.__.store.notify("splice",this,[this.length-1,1]):this},unshift:function(a){return this.prepend([a])},prepend:function(a){return a&&a.length?this.__.store.notify("splice",this,[0,0].concat(a)):this},shift:function(){return this.length?this.__.store.notify("splice",this,[0,1]):this},splice:function(a,b,c){return this.__.store.notify("splice",this,arguments)}},c),d=Object.create(Array.prototype,f.createNE(b)),g=f.createNE(f.extend({remove:function(a){var b=
[],c=a;a.constructor!=Array&&(c=[a]);a=0;for(var d=c.length;a<d;a++)this.hasOwnProperty(c[a])&&b.push(c[a]);return b.length?this.__.store.notify("remove",this,b):this}},c)),e=Object.create(Object.prototype,g),k=function(){return[].__proto__?function(a){a=Array(a);a.__proto__=d;return a}:function(a){a=Array(a);for(var c in b)a[c]=b[c];return a}}();this.clone=function(a){var b=a.constructor;return b==Array?k(a.length):b===Object?Object.create(e):Object.create(b.prototype,g)}}},t=["beforeAll","afterAll"],
u=f.createNonEnumerable({on:function(a,c,b){var d=this._events[a]||[];d.push({callback:c,once:b});this._events[a]=d;return this},once:function(a,c){return this.on(a,c,!0)},off:function(a,c){if("undefined"==typeof a)this._events={};else if("undefined"==typeof c)this._events[a]=[];else{var b=this._events[a]||[],d;for(d=b.length-1;0<=d;d--)b[d].callback===c&&b.splice(d,1)}return this},trigger:function(a){var c=[].slice.call(arguments,1),b=this._events[a]||[],d=[],g=-1!=t.indexOf(a),e,f,l,h;g||this.trigger.apply(this,
["beforeAll",a].concat(c));for(e=0;e<b.length;e++)f=b[e],f.callback?h=f.callback.apply(this,c):f.once=!0,f.once&&d.push(e),void 0!==h&&(l=h);for(e=d.length-1;0<=e;e--)b.splice(d[e],1);g||this.trigger.apply(this,["afterAll",a].concat(c));return l}}),q={freeze:function(a,c){if(a&&a.__)return a;var b=this,d=n.clone(a);f.addNE(d,{__:{listener:!1,parents:[],store:c}});f.each(a,function(a,e){f.isLeaf(a,c.freezeInstances)||(a=b.freeze(a,c));a&&a.__&&b.addParent(a,d);d[e]=a});c.freezeFn(d);return d},merge:function(a,
c){var b=a.__,d=b.trans;c=f.extend({},c);if(d){for(var g in c)d[g]=c[g];return a}var e=this,k=this.copyMeta(a),l=b.store,h,r,p;f.each(a,function(b,d){(p=b&&b.__)&&e.removeParent(b,a);h=c[d];if(!h)return p&&e.addParent(b,k),k[d]=b;f.isLeaf(h,l.freezeInstances)||(h=e.freeze(h,l));h&&h.__&&e.addParent(h,k);delete c[d];k[d]=h});for(r in c)h=c[r],f.isLeaf(h,l.freezeInstances)||(h=e.freeze(h,l)),h&&h.__&&e.addParent(h,k),k[r]=h;b.store.freezeFn(k);this.refreshParents(a,k);return k},replace:function(a,c){var b=
a.__,d=c;f.isLeaf(c,b.store.freezeInstances)||(d=this.freeze(c,b.store),d.__.parents=b.parents,d.__.updateRoot=b.updateRoot,b.listener&&(d.__.listener=b.listener));d&&this.fixChildren(d,a);this.refreshParents(a,d);return d},remove:function(a,c){var b=a.__.trans;if(b){for(var d=c.length-1;0<=d;d--)delete b[c[d]];return a}var g=this,e=this.copyMeta(a),k;f.each(a,function(b,d){(k=b&&b.__)&&g.removeParent(b,a);-1==c.indexOf(d)&&(k&&g.addParent(b,e),e[d]=b)});a.__.store.freezeFn(e);this.refreshParents(a,
e);return e},splice:function(a,c){var b=a.__,d=b.trans;if(d)return d.splice.apply(d,c),a;var g=this,e=this.copyMeta(a),k=c[0],l=k+c[1];f.each(a,function(b,c){b&&b.__&&(g.removeParent(b,a),(c<k||c>=l)&&g.addParent(b,e));e[c]=b});if(1<c.length)for(var h=c.length-1;2<=h;h--)d=c[h],f.isLeaf(d,b.store.freezeInstances)||(d=this.freeze(d,b.store)),d&&d.__&&this.addParent(d,e),c[h]=d;Array.prototype.splice.apply(e,c);b.store.freezeFn(e);this.refreshParents(a,e);return e},transact:function(a){var c=this,b=
a.__.trans,d;if(b)return b;d=a.constructor==Array?[]:{};f.each(a,function(a,b){d[b]=a});a.__.trans=d;f.nextTick(function(){a.__.trans&&c.run(a)});return d},run:function(a){var c=this,b=a.__.trans;if(!b)return a;f.each(b,function(b,f){b&&b.__&&c.removeParent(b,a)});delete a.__.trans;return this.replace(a,b)},pivot:function(a){a.__.pivot=1;this.unpivot(a);return a},unpivot:function(a){f.nextTick(function(){a.__.pivot=0})},refresh:function(a,c,b){var d=this,g=a.__.trans,e=0;if(g)return f.each(g,function(f,
h){e||f!==c||(g[h]=b,e=1,b&&b.__&&d.addParent(b,a))}),a;var k=this.copyMeta(a);f.each(a,function(e,f){e===c&&(e=b);e&&e.__&&(d.removeParent(e,a),d.addParent(e,k));k[f]=e});a.__.store.freezeFn(k);this.refreshParents(a,k)},fixChildren:function(a,c){var b=this;f.each(a,function(d){if(d&&d.__){b.fixChildren(d);if(1==d.__.parents.length)return d.__.parents=[a];c&&b.removeParent(d,c);b.addParent(d,a)}})},copyMeta:function(a){var c=n.clone(a);a=a.__;f.addNE(c,{__:{store:a.store,updateRoot:a.updateRoot,listener:a.listener,
parents:a.parents.slice(0),trans:a.trans,pivot:a.pivot}});a.pivot&&this.unpivot(c);return c},refreshParents:function(a,c){var b=a.__,d=b.parents.length;a.__.updateRoot&&a.__.updateRoot(a,c);c&&this.trigger(a,"update",c,b.store.live);if(d)for(--d;0<=d;d--)this.refresh(b.parents[d],a,c)},removeParent:function(a,c){var b=a.__.parents,d=b.indexOf(c);-1!=d&&b.splice(d,1)},addParent:function(a,c){var b=a.__.parents;-1==b.indexOf(c)&&(b[b.length]=c)},trigger:function(a,c,b,d){var g=a.__.listener;if(g){var e=
g.ticking;if(d){if(e||b)g.ticking=0,g.trigger(c,e||b,a)}else g.ticking=b,g.prevState||(g.prevState=a),e||f.nextTick(function(){if(g.ticking){var b=g.ticking;g.ticking=0;g.prevState=0;g.trigger(c,b,a)}})}},createListener:function(a){var c=a.__.listener;c||(c=Object.create(u,{_events:{value:{},writable:!0}}),a.__.listener=c);return c}};n.init(q);return function(a,c){var b=this,d=c||{},g={live:d.live||!1,freezeInstances:d.freezeInstances||!1},e,k=[],l=0,h=function(a){var b=a.__;if(b.listener){var c=
b.listener.prevState||a;b.listener.prevState=0;q.trigger(c,"update",a,!0)}for(a=0;a<b.parents.length;a++)b.store.notify("now",b.parents[a])},m=function(a){k.push(a);l||(l=1,f.nextTick(function(){k=[];l=0}))};g.notify=function(a,b,c){if("now"==a){if(k.length)for(;k.length;)h(k.shift());else h(b);return b}b=q[a](b,c);return"pivot"!=a&&(a=f.findPivot(b))?(m(b),a):b};g.freezeFn=!0===d.mutable?function(){}:function(a){Object.freeze(a)};e=q.freeze(a,g);e.__.updateRoot=function(a,b){a===e&&(e=b)};var p=
e.getListener(),n={};f.each(["on","off","once","trigger"],function(a){var c={};c[a]=p[a].bind(p);f.addNE(b,c);f.addNE(n,c)});f.addNE(this,{get:function(){return e},set:function(a){e.reset(a)},getEventHub:function(){return n}});f.addNE(this,{getData:this.get,setData:this.set})}});